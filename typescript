// Admin function to seed initial content
export const seedContent = mutation({
  args: {},
  handler: async (ctx) => {
    const initialContent = [
      {
        title: "Managing Diabetes: The Basics",
        type: "article",
        body: "Living with diabetes requires a comprehensive approach to health. Key pillars include monitoring blood sugar, maintaining a balanced diet rich in fiber and low in simple sugars, and regular physical activity. Consistency is key.",
        tags: ["Diabetes", "General"],
        source: "NIDDK",
        imageUrl: "https://images.unsplash.com/photo-1576091160550-217358c7b818?auto=format&fit=crop&q=80&w=1000",
        url: "https://www.niddk.nih.gov/health-information/diabetes/overview/managing-diabetes",
        publishedAt: Date.now(),
        author: "Dr. Sarah Smith"
      },
      {
        title: "5 Low-Sodium Recipes for Heart Health",
        type: "article",
        body: "Reducing sodium doesn't mean sacrificing flavor. Try these delicious alternatives using herbs, spices, and citrus to season your food. 1. Lemon Herb Chicken... 2. Garlic Roasted Veggies... 3. Spicy Bean Chili...",
        tags: ["Hypertension", "Heart Health"],
        source: "CDC",
        imageUrl: "https://images.unsplash.com/photo-1490645935967-10de6ba17061?auto=format&fit=crop&q=80&w=1000",
        url: "https://www.cdc.gov/salt/reduce_sodium_tips.htm",
        publishedAt: Date.now() - 86400000,
        author: "Chef Mike"
      },
      {
        title: "Did you know?",
        type: "tip",
        body: "Taking your medication at the same time every day can improve its effectiveness by up to 30% and helps you build a consistent habit.",
        tags: ["General", "Medication"],
        publishedAt: Date.now() - 172800000,
      },
      {
        title: "Gentle Yoga for Arthritis",
        type: "video",
        body: "A gentle yoga routine designed to help reduce joint pain and improve flexibility. Suitable for beginners and those with arthritis.",
        url: "https://www.youtube.com/watch?v=v7AYKMP6rOE",
        tags: ["Arthritis", "Exercise"],
        imageUrl: "https://images.unsplash.com/photo-1544367563-12123d8965cd?auto=format&fit=crop&q=80&w=1000",
        publishedAt: Date.now() - 259200000,
        source: "Yoga With Adriene"
      },
      {
        title: "Understanding Blood Pressure Readings",
        type: "article",
        body: "Systolic vs Diastolic: What do the numbers mean? Systolic (top number) measures pressure when your heart beats. Diastolic (bottom number) measures pressure between beats.",
        tags: ["Hypertension", "General"],
        source: "American Heart Association",
        imageUrl: "https://images.unsplash.com/photo-1628348068343-c6a848d2b6dd?auto=format&fit=crop&q=80&w=1000",
        url: "https://www.heart.org/en/health-topics/high-blood-pressure/understanding-blood-pressure-readings",
        publishedAt: Date.now() - 400000000,
      },
      {
        title: "The Benefits of Walking",
        type: "article",
        body: "Walking is a simple, low-impact way to improve your health. It can help lower blood pressure, improve mood, and support weight management.",
        tags: ["General", "Exercise"],
        source: "Mayo Clinic",
        imageUrl: "https://images.unsplash.com/photo-1476480862126-209bfaa8edc8?auto=format&fit=crop&q=80&w=1000",
        url: "https://www.mayoclinic.org/healthy-lifestyle/fitness/in-depth/walking/art-20046261",
        publishedAt: Date.now() - 500000000,
      },
      {
        title: "Stay Hydrated",
        type: "tip",
        body: "Drinking enough water is crucial for many bodily functions, including regulating temperature and keeping joints lubricated.",
        tags: ["General", "Wellness"],
        publishedAt: Date.now() - 600000000,
      },
      {
        title: "Meditation for Stress Relief",
        type: "video",
        body: "A guided meditation to help you relax and reduce stress levels. Take 10 minutes for yourself.",
        url: "https://www.youtube.com/watch?v=ssss7V1_eyA",
        tags: ["Mental Health", "Wellness"],
        imageUrl: "https://images.unsplash.com/photo-1506126613408-eca07ce68773?auto=format&fit=crop&q=80&w=1000",
        publishedAt: Date.now() - 700000000,
        source: "Great Meditation"
      },
      {
        title: "Healthy Sleep Habits",
        type: "article",
        body: "Good sleep is essential for good health. Learn how to improve your sleep hygiene with these simple tips.",
        tags: ["General", "Sleep"],
        source: "Sleep Foundation",
        imageUrl: "https://images.unsplash.com/photo-1511295742362-92c96b504802?auto=format&fit=crop&q=80&w=1000",
        url: "https://www.sleepfoundation.org/sleep-hygiene",
        publishedAt: Date.now() - 800000000,
      },
      {
        title: "Quick Stress Buster",
        type: "tip",
        body: "Take 3 deep breaths. Inhale for 4 seconds, hold for 4 seconds, exhale for 4 seconds. Repeat.",
        tags: ["Mental Health", "Stress"],
        publishedAt: Date.now() - 900000000,
      },
      {
        title: "10 Superfoods for Heart Health",
        type: "article",
        body: "Incorporating these nutrient-rich foods into your diet can help lower cholesterol and blood pressure.",
        tags: ["Heart Health", "Nutrition"],
        source: "Healthline",
        imageUrl: "https://images.unsplash.com/photo-1498837167922-ddd27525d352?auto=format&fit=crop&q=80&w=1000",
        url: "https://www.healthline.com/nutrition/heart-healthy-foods",
        publishedAt: Date.now() - 100000000,
      },
      {
        title: "Morning Stretch Routine",
        type: "video",
        body: "Start your day with energy using this simple 10-minute full body stretch routine.",
        url: "https://www.youtube.com/watch?v=sAf67xFS-qA",
        tags: ["Exercise", "Wellness"],
        imageUrl: "https://images.unsplash.com/photo-1518611012118-696072aa579a?auto=format&fit=crop&q=80&w=1000",
        publishedAt: Date.now() - 200000000,
        source: "MadFit"
      }
    ];

    // Fetch all existing content to check for updates
    const allExisting = await ctx.db.query("content").collect();
    const existingMap = new Map(allExisting.map(item => [item.title, item]));

    for (const item of initialContent) {
      const existing = existingMap.get(item.title);

      if (existing) {
        // Update if missing URL, has placeholder URL, or just to ensure data is fresh
        if ((!existing.url && item.url) || 
            (existing.url && existing.url.includes("example")) ||
            (item.url && existing.url !== item.url)) {
           console.log("Updating content:", item.title);
           await ctx.db.patch(existing._id, {
             url: item.url,
             imageUrl: item.imageUrl || existing.imageUrl,
             body: item.body,
             source: item.source
           });
        }
      } else {
        console.log("Creating content:", item.title);
        await ctx.db.insert("content", item as any);
      }
    }

  }
});

// Auto-seed/update content if empty or missing URLs
useEffect(() => {
  if (feed) {
    // Check if we have any articles that are missing URLs or have placeholder URLs
    const hasIncompleteData = feed.some(item => 
      (item.type === 'article' || item.type === 'video') && 
      (!item.url || item.url.includes("example"))
    );
    
    const needsUpdate = feed.length === 0 || hasIncompleteData;
    
    if (needsUpdate) {
      toast.info("Refreshing content library with valid sources...");
      seedContent();
    }
  }
}, [feed, seedContent]);